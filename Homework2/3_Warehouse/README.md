# 仓库管理系统

## 项目概述

本项目实现了一个基于Java多线程的仓库管理系统。系统包含三个货物容量为20的仓库，两个fetch线程和一个save线程。线程可以从仓库中取出或存入1-5个单位的货物。

## 实现要求

1. 有三个货物容量为20的仓库
2. 两个fetch线程和一个save线程
3. 每次存取1-5个单位的仓库货物
4. save线程会选择货物最少的仓库存放货物，如果仓库会溢出进入wait状态
5. fetch线程会选择货物最多的仓库取出货物，如果仓库取空还不够会进入wait状态
6. 如果符合条件有2-3个仓库库存相等则任选一个操作

## 死锁问题分析

题目中特别提到不能在程序中连续写：

```java
warehouse1.wait();
warehouse2.wait();
warehouse3.wait();
```

这是因为这样会导致死锁问题。分析原因：

1. 当线程调用某个对象的wait()方法时，它会释放该对象的锁并进入等待状态
2. 如果连续对多个仓库调用wait()，那么线程必须先获得所有仓库的锁
3. 这会导致以下问题：
   - 如果一个线程持有warehouse1的锁并等待warehouse2的锁
   - 同时另一个线程持有warehouse2的锁并等待warehouse1的锁
   - 两个线程就会永远等待对方释放锁，形成死锁

## 解决方案

本项目采用了以下方案解决这个问题：

1. 使用仓库管理器（WarehouseManager）集中管理所有仓库
2. 线程不直接操作多个仓库，而是通过管理器选择合适的单个仓库进行操作
3. 每个线程在任一时刻只持有一个仓库的锁
4. 使用notify/notifyAll机制在操作完成后通知其他等待的线程

## 项目结构

本项目包含以下几个主要类：

1. **Warehouse** - 表示单个仓库，提供同步的存取方法
2. **WarehouseManager** - 管理多个仓库，提供选择合适仓库的方法
3. **FetchThread** - 取货线程，从仓库中取出货物
4. **SaveThread** - 存货线程，向仓库中存入货物
5. **WarehouseSystem** - 主程序类，创建并启动线程，处理用户输入

## 运行说明

可以通过以下命令编译并运行程序：

```bash
# 编译
javac Homework2/3_Warehouse/src/*.java

# 运行
java -cp Homework2/3_Warehouse/src WarehouseSystem
```

## 输入格式

程序接受以下格式的输入：

```
线程ID 数量
```

其中：
- 线程ID：1表示fetch1线程，2表示fetch2线程，3表示save线程
- 数量：要存取的货物数量（1-5之间）

例如：
- `1 3` 表示fetch1线程取3个单位货物
- `2 3` 表示fetch2线程取3个单位货物
- `3 3` 表示save线程存储3个单位货物

输入 `exit` 退出程序。

## 实现细节

### 线程同步

- 使用synchronized方法确保对仓库的操作是线程安全的
- 使用wait()/notifyAll()机制实现线程间的协作
- 每个线程在等待新操作时会进入等待状态，收到通知后才会执行操作

### 仓库选择策略

- save线程选择库存最少的仓库进行存储
- fetch线程选择库存最多的仓库进行取出
- 如果有多个仓库库存相同，则选择第一个符合条件的仓库

### 错误处理

- 验证用户输入的格式和数值范围
- 处理线程中断异常
- 程序退出时优雅地关闭所有线程 